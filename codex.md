# Pet Friends Screenshot: High-Accuracy Strategy (No Code Changes Yet)

## 背景结论
你已经验证了两条路线：
- 1fps：约 10% 准确
- 每个时间点 ±5 帧：约 70% 准确

这说明问题不是“多截几帧”本身，而是**目标定位链路不稳定**：时间点不准 + 框不准 + 缺少质量门禁 + 缺少可恢复回退。

> 现实约束：真实视频里“100%全自动全身准确”通常不可保证（遮挡、模糊、出画、远景）。可行目标是**95%+自动准确率 + 失败样本自动回退可用图**。

---

## 新方案（推荐）：Detect → Track → ReID → Quality Gate → Final Crop

这是一个“先定位、再确认、最后裁剪”的稳定管线，不再依赖单点时间戳命中。

### 阶段 1：候选窗口生成（不要只看单时间点）
- 对每个 friend 的每次 interaction，建立时间窗口：`[t-3s, t+3s]`。
- 窗口内按 6~10fps 抽样（不是 1fps）。
- 目的：覆盖 AI 时间戳偏差和快速运动，避免“刚好错过”。

### 阶段 2：本地检测（轻量、稳定）
- 用本地动物检测器（如 YOLOv8n / RT-DETR small）对每帧出框。
- 保留类别=cat/dog 等、置信度高于阈值的框。
- 这一步只做“哪里有动物”，不做身份判定。

### 阶段 3：短时跟踪（解决抖动和漏检）
- 在窗口内对检测框做多目标跟踪（ByteTrack/DeepSORT）。
- 形成 tracklet（连续轨迹），得到每个候选动物的稳定轨迹。
- 对短时漏检由跟踪补齐，减少“某帧没框就失败”。

### 阶段 4：身份绑定（ReID + 语义双保险）
- 为每个 friend 建立“身份锚点”：
  - 来自主分析中最清晰的一帧或人工选一张参考图。
- 对每条 tracklet 计算 ReID 相似度（embedding cosine）。
- 只对前2名候选再做 1 次 Gemini 语义确认（如“Snowy异瞳白猫”）。
- 结果：把“是哪只猫”从时间问题转成身份匹配问题。

### 阶段 5：质量门禁（保证不是草地图）
候选帧必须同时通过：
1. **可见性**：框面积占比在合理区间（如 6%~65%）
2. **完整性**：框不贴边（距离边界 > 2~3%）
3. **清晰度**：拉普拉斯清晰度 > 阈值
4. **姿态完整**：优先 head+torso/full body（可用关键点或规则）
5. **稳定性**：前后邻帧IoU稳定，不是瞬时误检

未通过则自动换同轨迹下一帧，直到通过或窗口耗尽。

### 阶段 6：最终裁剪策略（高分辨率且可回退）
- 先在 proxy 上选中“最佳帧索引 + 框”，再映射到原视频同帧。
- 裁剪时使用自适应padding（30%~50%），并检查裁后完整性。
- 若所有候选都失败：
  - 返回“原帧+可视化框”而不是错误裁剪；
  - 标记 `needs_review=true` 进入轻量人工复核池。

---

## 为什么这个方案比“1fps/±5帧”更准
- 不是押注单时间点，而是**窗口搜索 + 跟踪恢复**。
- 不是仅看“有没有猫”，而是**身份绑定（ReID）**。
- 不是找到就裁，而是**质量门禁**先过滤草地/半身/模糊。
- 不是失败即坏图，而是**可回退**到可用结果。

---

## 性能目标（可落地）
- 每个 friend 每个 interaction：6 秒窗口 × 8fps ≈ 48 帧。
- 本地检测+跟踪在CPU/GPU都可并行，吞吐远高于多次云端验证。
- 云端 Gemini 调用降到“每个 friend 0~2 次确认”，不再 5xN。
- 预计 friend 截图阶段可控制在总时长 **<10%**（取决于硬件）。

---

## 最小化实施路线（按优先级）
1. 先上“本地检测 + 质量门禁 + 失败回退”（最快见效）
2. 再加“短时跟踪”提升稳定性
3. 最后加“ReID + 单次语义确认”解决同类猫混淆

---

## 验收标准（建议）
- 指标1：朋友截图准确率（人工标注）≥ 95%
- 指标2：草地/土壤误裁率 ≤ 1%
- 指标3：朋友阶段耗时占比 ≤ 10%
- 指标4：失败样本全部回退为“可用图（非错裁）”

---

## 关键原则（必须遵守）
- 没有可靠框，不允许裁剪。
- 任何贴边/模糊/小目标帧，不允许作为最终图。
- 宁可回退整帧，也不要输出错误裁图。

